---
title: "Analysing differential hydrogen deuterium exchange mass spectrometry data"
author:
- name: Oliver M. Crook
- name: Broncio Aguilar-Sanjuan
package: hdxstats
output:
  BiocStyle::html_document:
    toc_float: yes
abstract: "This vignette describes how to analyse a mass-spectrometry based  hydrogen
  deuterium exchange experiment, in particular we focus on empirical Bayes functional
  models and visualisations. \n"
vignette: |
  %\VignetteIndexEntry{Analysing differential hydrogen deuterium exchange mass spectrometry data}
  %\VignetteEngine{knitr::rmarkdown}
  %%\VignetteKeywords{Mass Spectrometry, MS, MSMS, Proteomics, Metabolomics, Infrastructure, Quantitative} %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r env, message = FALSE, warning = FALSE, echo = FALSE}
library("hdxstats")
library("dplyr")
library("ggplot2")
library("RColorBrewer")
library("tidyr")
library("pheatmap")
library("scales")
library("viridis")
library("patchwork")
library("Biostrings")

```

# Protection/deprotection maps

Users may also wish to colour according to protection or deprotections of hdx.
The following functions determine whether there is protection or not by
computing deuterium difference. The users pass the argument for which
to compute the differences. The user pass can any scores though it is useful
to look at the FDR provided by previous analysis. As is typical blue
indicates protection whilst red deprotection. The binding epitope is very
clear from these diagrams.

```{r, fig.width= 22, fig.height = 15}
scores <- funresdAb27_2@results$ebayes.fdr
hdxdiff1 <- hdxdifference(object = newqDF2,
              AAString = HOIPfasta[[1]],
              peptideSeqs = unique(HOIP$Sequence),
              numlines = 2,
              maxmismatch = 1,
              by = 10,
              scores = scores[unique(HOIP$Sequence)],
              cols = c(2,5), # columns of object to use for differences
              name = "-log10 p value (signed)")

scores <- funresdAb25_1@results$ebayes.fdr
hdxdiff2 <- hdxdifference(object = newqDF,
              AAString = HOIPfasta[[1]],
              peptideSeqs = unique(HOIP$Sequence),
              numlines = 2,
              maxmismatch = 1,
              by = 10,
              scores = scores[unique(HOIP$Sequence)],
              cols = c(2,5),
              name = "-log10 p value (signed)")

dMap <- list(hdxdiff1$diffMap, hdxdiff2$diffMap)
out4 <- hdxheatmap(averageMaps = avMap, diffMaps = dMap)
out4[[1]]/out4[[2]]  + plot_layout(guides = 'collect') & theme(legend.position = "right")
```
# Visualise data in PDB structure

Load essential libraries

```{r,}
library("NGLVieweR")
library("tidyverse")
library("RColorBrewer")
library("scales")
library("comprehenr")
```

Visualise differential HDX data

```{r}
# Load essential libraries
library("shiny")
library("NGLVieweR")
library("tidyverse")
library("RColorBrewer")
library("scales")
library("comprehenr")
library("dplyr")
library("bio3d")
library("psych") # to compute harmonic.mean
library("data.table") # to transpose table
library("shinydashboard")
library("DT")
library("markdown")
library("shinyWidgets")
library("shinyBS") # Additional Bootstrap Controls
```


```{r}
map_hdx2pdb <- function(dataset, pdb_filepath) {
  
  # Extract residue numbers from available residues in PDB coordinates ---
  
  pdb_content <- read.pdb(pdb_filepath)
  sequence_from_pdb <- pdbseq(pdb_content)
  sequence_residue_numbers_pdb <- strtoi(row.names(data.frame(sequence_from_pdb)))
  n_residues_from_pdb <- nchar(paste(sequence_from_pdb, collapse=""))
  
  # Work out residues and deprotection values to map onto PDB ---
  
  print(paste("Your HDX input dataset has ", length(colnames(dataset)), "entries"))
  print(paste("And excluding NA data you only have", length(dataset[!is.na(dataset)]), "entries"))
  print(paste("However, your input PDB has only", n_residues_from_pdb, "residues in total"))
  
  sequence_residue_numbers_hdx <- seq(length(dataset)) # NEED TO TWEAK THIS!!!
  residue_numbers_hdx_pdb <- intersect(sequence_residue_numbers_hdx, sequence_residue_numbers_pdb)
  aa_sequence_from_pdb <- sequence_from_pdb[sequence_residue_numbers_pdb %in% residue_numbers_hdx_pdb]
  aa_sequence_from_pdb <- as.vector(aa_sequence_from_pdb)
  
  dataset_for_pdb_mapping <- dataset[residue_numbers_hdx_pdb]
  pdb_viewer_data <- list("values"= dataset_for_pdb_mapping,"residues"= residue_numbers_hdx_pdb, "aa"= aa_sequence_from_pdb)
  
  # Define colour map --
  colormap <- colorRampPalette(brewer.pal(n=9, name="RdBu"))
  domain <- c(-2.0,2.0)
  color_function <- col_bin(colormap, domain, na.color="#FFD700")
  
  residue_selections <- pdb_viewer_data$residues
  df <- data.frame(x=unlist(lapply(pdb_viewer_data$values, color_function)), y=residue_selections)
  color_parameters <- to_list(for(i in 1:length(residue_selections)) c(df$x[i], df$y[i]))
  
  # Colour PDB residues in dark grey when no HDX data availables
  residue_numbers_pdb_NOT_hdx <- setdiff(sequence_residue_numbers_pdb, sequence_residue_numbers_hdx)
  color_parameters_null <- to_list(for(i in 1:length(residue_numbers_pdb_NOT_hdx)) c("#696969", residue_numbers_pdb_NOT_hdx[i]))
  
  #return(append(color_parameters, color_parameters_null))
  return(color_parameters)
}
```


```{r}
dataset <- hdxdiff1$averageMap
scale_limits <- c(min(dataset[!is.na(dataset)]), max(dataset[!is.na(dataset)]))

# Antigen PDB coordinate file
pdb_filepath <- "data/5edv_chainA_clean_renumbered.pdb"
mycolor_parameters <- map_hdx2pdb(dataset, pdb_filepath)
```


```{r}
NGLVieweR(pdb_filepath) %>%
  stageParameters(backgroundColor = "white", zoomSpeed = 1) %>%
  addRepresentation("cartoon") %>%
  addRepresentation("cartoon", param = list(color=mycolor_parameters, backgroundColor="white")) #%>%
  #setSpin()
```

