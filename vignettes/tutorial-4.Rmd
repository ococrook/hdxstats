---
title: "Analysing differential hydrogen deuterium exchange mass spectrometry data"
author:
- name: Oliver M. Crook
- name: Broncio Aguilar-Sanjuan
package: hdxstats
output:
  BiocStyle::html_document:
    toc_float: yes
abstract: "This vignette describes how to analyse a mass-spectrometry based  hydrogen
  deuterium exchange experiment, in particular we focus on empirical Bayes functional
  models and visualisations. \n"
vignette: |
  %\VignetteIndexEntry{Analysing differential hydrogen deuterium exchange mass spectrometry data: tutorial 4}
  %\VignetteEngine{knitr::rmarkdown}
  %%\VignetteKeywords{Mass Spectrometry, MS, MSMS, Proteomics, Metabolomics, Infrastructure, Quantitative} %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r env, message = FALSE, warning = FALSE, echo = FALSE}
library("hdxstats")
library("dplyr")
library("ggplot2")
library("RColorBrewer")
library("tidyr")
library("pheatmap")
library("scales")
library("viridis")
library("patchwork")
library("Biostrings")

```

# Protection/deprotection maps

Users may also wish to colour according to protection or deprotections of hdx.
The following functions determine whether there is protection or not by
computing deuterium difference. The users pass the argument for which
to compute the differences. The user pass can any scores though it is useful
to look at the FDR provided by previous analysis. As is typical blue
indicates protection whilst red deprotection. The binding epitope is very
clear from these diagrams.

```{r, fig.width= 22, fig.height = 15}
scores <- funresdAb27_2@results$ebayes.fdr
hdxdiff1 <- hdxdifference(object = newqDF2,
              AAString = HOIPfasta[[1]],
              peptideSeqs = unique(HOIP$Sequence),
              numlines = 2,
              maxmismatch = 1,
              by = 10,
              scores = scores[unique(HOIP$Sequence)],
              cols = c(2,5), # columns of object to use for differences
              name = "-log10 p value (signed)")

scores <- funresdAb25_1@results$ebayes.fdr
hdxdiff2 <- hdxdifference(object = newqDF,
              AAString = HOIPfasta[[1]],
              peptideSeqs = unique(HOIP$Sequence),
              numlines = 2,
              maxmismatch = 1,
              by = 10,
              scores = scores[unique(HOIP$Sequence)],
              cols = c(2,5),
              name = "-log10 p value (signed)")

dMap <- list(hdxdiff1$diffMap, hdxdiff2$diffMap)
out4 <- hdxheatmap(averageMaps = avMap, diffMaps = dMap)
out4[[1]]/out4[[2]]  + plot_layout(guides = 'collect') & theme(legend.position = "right")
```

# Visualise data in PDB structure

Load essential libraries

```{r,}
library("NGLVieweR")
library("tidyverse")
library("RColorBrewer")
library("scales")
library("comprehenr")
library("bio3d")
```

Map protection/deprotection heatmaps onto PDB

```{r}
source("../R/pdb-visualisation.R")
```


```{r}
dataset <- avMap25_1 * sign(hdxdiff1$diffMap)
pdb_filepath <- "data/5edv_chainA_clean_renumbered.pdb"
mycolor_parameters <- hdx_to_pdb_colours(dataset, pdb_filepath, cmap_name="ProtDeprot")
```


```{r}
NGLVieweR(pdb_filepath) %>%
  stageParameters(backgroundColor = "white", zoomSpeed = 1) %>%
  addRepresentation("cartoon") %>%
  addRepresentation("cartoon", param = list(color=mycolor_parameters, backgroundColor="white")) #%>%
  #setSpin()
```

Map protection/deprotection heatmaps onto PDB

```{r}
dataset <- avMap27_2 * sign(hdxdiff2$diffMap)
pdb_filepath <- "data/5edv_chainA_clean_renumbered.pdb"
mycolor_parameters <- hdx_to_pdb_colours(dataset, pdb_filepath, cmap_name="ProtDeprot")
```


```{r}
NGLVieweR(pdb_filepath) %>%
  stageParameters(backgroundColor = "white", zoomSpeed = 1) %>%
  addRepresentation("cartoon") %>%
  addRepresentation("cartoon", param = list(color=mycolor_parameters, backgroundColor="white")) #%>%
  #setSpin()
```
Map Epitope data


```{r}
dataset <- avMap25_1
pdb_filepath <- "data/5edv_chainA_clean_renumbered.pdb"
mycolor_parameters <- hdx_to_pdb_colours(dataset, pdb_filepath)
```


```{r}
NGLVieweR(pdb_filepath) %>%
  stageParameters(backgroundColor = "white", zoomSpeed = 1) %>%
  addRepresentation("cartoon") %>%
  addRepresentation("cartoon", param = list(color=mycolor_parameters, backgroundColor="white")) #%>%
  #setSpin()
```

```{r}
dataset <- avMap27_2
pdb_filepath <- "data/5edv_chainA_clean_renumbered.pdb"
mycolor_parameters <- hdx_to_pdb_colours(dataset, pdb_filepath)
```


```{r}
NGLVieweR(pdb_filepath) %>%
  stageParameters(backgroundColor = "white", zoomSpeed = 1) %>%
  addRepresentation("cartoon") %>%
  addRepresentation("cartoon", param = list(color=mycolor_parameters, backgroundColor="white")) #%>%
  #setSpin()
```

