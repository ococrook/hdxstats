---
title: "Analysing differential hydrogen deuterium exchange mass spectrometry data"
author:
- name: Oliver M. Crook
- name: Broncio Aguilar-Sanjuan
package: hdxstats
output:
  BiocStyle::html_document:
    toc_float: yes
abstract: "This vignette describes how to analyse a mass-spectrometry based  hydrogen
  deuterium exchange experiment, in particular we focus on empirical Bayes functional
  models and visualisations. \n"
vignette: |
  %\VignetteIndexEntry{Analysing differential hydrogen deuterium exchange mass spectrometry data}
  %\VignetteEngine{knitr::rmarkdown}
  %%\VignetteKeywords{Mass Spectrometry, MS, MSMS, Proteomics, Metabolomics, Infrastructure, Quantitative} %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r env, message = FALSE, warning = FALSE, echo = FALSE}
library("hdxstats")
library("dplyr")
library("ggplot2")
library("RColorBrewer")
library("tidyr")
library("pheatmap")
library("scales")
library("viridis")
library("patchwork")
library("Biostrings")

```

# Multi-level testing

Advanced users and those struggling to find any significant results may wish to 
employ a more complex method. Here, we introduce a multi-level testing procedure
that allows us to combine p-values in the spatial axis of the data. Individual
p-value may not be significant but once grouped we might obtain additional power.
This approach also controls a different form of multiplicity correction called
the strong-sense family wise error rate (ssFWER). The FWER is the probability
of of making at least one type 1 error (false discovery) and is hence a more
stringent notion than FDR. We control this quantity in the strong sense,
which means we do not require the global null hypothesis to be true. Typically,
we wish to control this quantity at some level $\alpha = 0.05$, which means
the probability of there being at least one false discovery is less than $0.05$.
Our strategy combines $p$-values in the spatial axis using the harmonic mean
p-value approach. The cost for this is that the regions which we cover become 
wider, potentially impacting interpretation. Furthermore, becuase of combining
p-values it no longer makes sense to examine protection/deprotection factors. 
However, it is valid to then examine only the region with significant results
without affecting multiplicity. In the following code chunk, we combined
p-values spatially and control for multiplicity using an interval of size 20.
This means a sliding window of $20$ peptide is used to combine p-values. The
region that this covers is plotted in the x-axis. For example, from the plot
below we can deduce that there is at least 1 peptide in region [49,120] where
there is a significant difference, where the probability that this is a false
discovery is $0.05$.

```{r, fig.width= 22, fig.height = 6}
hmpplot <- hmpWindow(params = funresdAb25_1,
                     sequences = HOIP$Sequence,
                     region = HOIP[, c("Start", "End")],
                     interval = 20)

hmpplot

```



# Exporting results

We suggest saving files in `.rds` format. However, if you wish to export data
to `.csv` format this can be done as in the following exampe.

```{r, eval=FALSE }
# not run
write.csv(funresdAb25_1@results, file = "data/myhdxresuts.csv")

```